<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>ãƒ«ãƒ¼ãƒ ä¸€è¦§</title>
  <link rel="stylesheet" href="/static/css/room_list.css">
</head>

<body>
  <div class="container">
    <h1 class="title">ãƒ«ãƒ¼ãƒ ä¸€è¦§</h1>

    <div id="roomList" class="room-list"></div>

    <div class="buttons">
      <button onclick="location.href='/room/create'">ğŸ  ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
      <button onclick="location.href='/mode'">æˆ»ã‚‹</button>
    </div>
  </div>

  <script>
    async function fetchRooms() {
      try {
        const res = await fetch("/room/list");
        const data = await res.json();

        const list = document.getElementById("roomList");
        list.innerHTML = "";

        if (!data.rooms || data.rooms.length === 0) {
          list.innerHTML = "<p>ç¾åœ¨ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
          return;
        }

        data.rooms.forEach(room => {
          const isFull = room.current_players >= room.max_players;

          const div = document.createElement("div");
          div.className = "room-card";

          div.innerHTML = `
        <div class="room-info">
          <p class="room-name">
            ${room.name}
            ${room.has_password ? "ğŸ”’" : ""}
          </p>
          <p>
            äººæ•°ï¼š${room.current_players} / ${room.max_players}
          </p>
        </div>

        <button
          ${isFull ? "disabled" : ""}
          onclick="joinRoom('${room.id}', ${room.has_password})">
          ${isFull ? "æº€å“¡" : "å‚åŠ "}
        </button>
      `;

          list.appendChild(div);
        });

      } catch (e) {
        alert("ãƒ«ãƒ¼ãƒ å–å¾—å¤±æ•—");
      }
    }

    async function joinRoom(roomId, hasPassword) {
      if (hasPassword) {
        const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (!password) return;
        localStorage.setItem("room_password", password);
      }

      // APIã§å‚åŠ ç™»éŒ²
      const userId = localStorage.getItem("user_id");
      const form = new FormData();
      form.append("room_id", roomId);

      try {
        await fetch("/room/join", {
          method: "POST",
          headers: { "Authorization": userId },
          body: form
        });
      } catch (e) {
        console.error("Join error:", e);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã¨ã‚Šã‚ãˆãšé€²ã‚€ã‹ã€ã‚¢ãƒ©ãƒ¼ãƒˆå‡ºã™ã‹
      }

      window.location.href = `/multi_play.html?room_id=${roomId}`;
    }

    fetchRooms();
  </script>

</body>

</html>